
echo "ğŸ” Running pre-push checks..."

if [ "$CI" = "true" ]; then
  echo "âœ… CI environment detected. Skipping branch check."
  exit 0
fi

# Prevent direct pushes to main
if [ "$CURRENT_BRANCH" = "main" ]; then
  echo "âŒ Direct pushes to '$CURRENT_BRANCH' are not allowed."
  echo "â¡ï¸  Please use a feature branch and open a PR."
  exit 1
fi

# Fetch the latest from origin
echo "ğŸŒ Fetching latest changes from origin..."
git fetch origin

# Check if current branch is behind dev
if [ "$CURRENT_BRANCH" != "main" ]; then
  BEHIND_COMMITS=$(git rev-list HEAD..origin/dev --count)

  if [ "$BEHIND_COMMITS" -gt 0 ]; then
    echo "âš ï¸ Your branch is $BEHIND_COMMITS commits behind 'origin/dev'."
    echo "ğŸ”„ Please pull or rebase from 'dev' before committing."
    exit 1
  fi
fi

echo "ğŸ” Running tests..."
npm test --workspace=backend